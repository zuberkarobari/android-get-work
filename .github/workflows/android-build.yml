name: Build Android APK (Capacitor + Vite)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '18'
      JAVA_VERSION: '17'
      CMDLINE_URL: 'https://dl.google.com/android/repository/commandlinetools-linux-10125470_latest.zip'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install NPM dependencies
        run: npm install --no-audit --no-fund

      - name: Build web assets (Vite)
        run: npm run build

      - name: Install Java (OpenJDK 17) and basic tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openjdk-${{ env.JAVA_VERSION }}-jdk unzip wget zip lib32stdc++6 lib32gcc-s1

      - name: Install Android SDK cmdline tools and platforms (robust download)
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
          CMDLINE_URL: ${{ env.CMDLINE_URL }}
        run: |
          set -eux

          sudo apt-get update -y
          sudo apt-get install -y unzip wget zip lib32stdc++6 lib32gcc-s1

          export ANDROID_SDK_ROOT=${{ runner.temp }}/android-sdk
          mkdir -p "$ANDROID_SDK_ROOT"
          cd "$ANDROID_SDK_ROOT"

          TMP_ZIP=/tmp/cmdline.zip
          MAX_ATTEMPTS=5
          attempt=0
          success=0

          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            attempt=$((attempt+1))
            echo "Download attempt $attempt/$MAX_ATTEMPTS..."
            # try wget first
            if wget -q -O "$TMP_ZIP" "$CMDLINE_URL"; then
              echo "Downloaded with wget"
              success=1
              break
            fi
            # fallback to curl
            if command -v curl >/dev/null 2>&1 && curl -fSL -o "$TMP_ZIP" "$CMDLINE_URL"; then
              echo "Downloaded with curl"
              success=1
              break
            fi
            echo "Download attempt $attempt failed; sleeping before retry..."
            sleep 5
          done

          if [ "$success" -ne 1 ]; then
            echo "ERROR: Failed to download command line tools after $MAX_ATTEMPTS attempts."
            echo "Last attempt exit code: $?"
            # show some network debugging
            echo "=== Network debug ==="
            nslookup dl.google.com || true
            ping -c 3 dl.google.com || true
            curl -I "$CMDLINE_URL" || true
            exit 1
          fi

          # unzip into cmdline-tools dir
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          unzip -q "$TMP_ZIP" -d "$ANDROID_SDK_ROOT/cmdline-tools"

          # Normalize to cmdline-tools/latest
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" ]; then
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          elif [ -d "$ANDROID_SDK_ROOT/cmdline-tools/tools" ]; then
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          else
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/" || true
          fi

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # Accept licenses (non-interactive)
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true

          # Install required packages (with retries)
          attempts=0
          until [ $attempts -ge 3 ]
          do
            sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2" && break
            attempts=$((attempts+1))
            echo "sdkmanager install failed; retrying ($attempts/3)..."
            sleep 5
          done

          # show installed packages for debugging
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --list || true

      - name: Setup Capacitor CLI and prepare Android project
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          PATH: ${{ runner.temp }}/android-sdk/cmdline-tools/latest/bin:${PATH}
        run: |
          npm install -g @capacitor/cli@5
          npx cap sync android || true

      - name: Ensure android folder exists (add if missing)
        if: always()
        run: |
          if [ ! -d "./android" ]; then
            echo "android folder missing — attempting to add Android platform via Capacitor"
            npx cap add android || true
          else
            echo "android folder exists"
          fi

      - name: Build Android APK (Gradle assembleDebug)
        working-directory: android
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          PATH: ${{ runner.temp }}/android-sdk/platform-tools:${PATH}
        run: |
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew || true
            ./gradlew assembleDebug --no-daemon
          else
            echo "gradlew not found in android directory — cannot run Gradle build"
            exit 1
          fi

      - name: Upload debug APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: getwork-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
